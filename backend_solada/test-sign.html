<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronia - Test Sign Message</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            background: #512da8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #673ab7;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            word-wrap: break-word;
        }
        .step {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üîê Cronia - Test Sign Message</h1>

    <div class="step">
        <h2>Step 1: Connect Wallet</h2>
        <button onclick="connectWallet()">Connect Phantom/Solflare</button>
        <div id="wallet-info" class="output" style="display:none;">
            <strong>Connected:</strong> <span id="wallet-address"></span>
        </div>
    </div>

    <div class="step">
        <h2>Step 2: Get Challenge</h2>
        <button onclick="getChallenge()">Get Challenge from API</button>
        <div id="challenge-output" class="output" style="display:none;">
            <strong>Message to sign:</strong>
            <pre id="challenge-message"></pre>
        </div>
    </div>

    <div class="step">
        <h2>Step 3: Sign Message</h2>
        <button onclick="signMessage()">Sign with Wallet</button>
        <div id="signature-output" class="output" style="display:none;">
            <strong>Signature (Base58):</strong>
            <pre id="signature"></pre>
        </div>
    </div>

    <div class="step">
        <h2>Step 4: Verify & Login</h2>
        <button onclick="verifyAndLogin()">Verify Signature & Login</button>
        <div id="login-output" class="output" style="display:none;">
            <strong>JWT Token:</strong>
            <pre id="jwt-token"></pre>
        </div>
    </div>

    <script>
        let walletAddress = null;
        let challengeMessage = null;
        let signature = null;

        // Step 1: Connect Wallet
        async function connectWallet() {
            try {
                if (!window.solana) {
                    alert('Phantom wallet not found! Please install Phantom or Solflare.');
                    return;
                }

                const resp = await window.solana.connect();
                walletAddress = resp.publicKey.toString();

                document.getElementById('wallet-address').textContent = walletAddress;
                document.getElementById('wallet-info').style.display = 'block';

                console.log('Connected:', walletAddress);
            } catch (err) {
                console.error('Error connecting wallet:', err);
                alert('Error connecting wallet: ' + err.message);
            }
        }

        // Step 2: Get Challenge
        async function getChallenge() {
            if (!walletAddress) {
                alert('Please connect wallet first!');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/v1/auth/challenge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress
                    })
                });

                const data = await response.json();
                challengeMessage = data.message;

                document.getElementById('challenge-message').textContent = challengeMessage;
                document.getElementById('challenge-output').style.display = 'block';

                console.log('Challenge:', challengeMessage);
            } catch (err) {
                console.error('Error getting challenge:', err);
                alert('Error getting challenge: ' + err.message);
            }
        }

        // Step 3: Sign Message
        async function signMessage() {
            if (!challengeMessage) {
                alert('Please get challenge first!');
                return;
            }

            try {
                const encodedMessage = new TextEncoder().encode(challengeMessage);
                const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');

                // Convert signature to Base58
                signature = bs58.encode(signedMessage.signature);

                document.getElementById('signature').textContent = signature;
                document.getElementById('signature-output').style.display = 'block';

                console.log('Signature:', signature);
            } catch (err) {
                console.error('Error signing message:', err);
                alert('Error signing message: ' + err.message);
            }
        }

        // Step 4: Verify and Login
        async function verifyAndLogin() {
            if (!signature) {
                alert('Please sign message first!');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/v1/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        message: challengeMessage,
                        signature: signature,
                        userType: 'consumer'
                    })
                });

                const data = await response.json();

                if (data.accessToken) {
                    document.getElementById('jwt-token').textContent = data.accessToken;
                    document.getElementById('login-output').style.display = 'block';

                    // Save token to localStorage
                    localStorage.setItem('cronia_token', data.accessToken);

                    console.log('Login successful!', data);
                    alert('Login successful! Token saved to localStorage.');
                } else {
                    alert('Login failed: ' + JSON.stringify(data));
                }
            } catch (err) {
                console.error('Error verifying:', err);
                alert('Error verifying: ' + err.message);
            }
        }

        // Base58 encoding library (bs58)
        const bs58 = (function() {
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            const BASE = ALPHABET.length;

            return {
                encode: function(buffer) {
                    if (buffer.length === 0) return '';

                    let digits = [0];
                    for (let i = 0; i < buffer.length; i++) {
                        let carry = buffer[i];
                        for (let j = 0; j < digits.length; j++) {
                            carry += digits[j] << 8;
                            digits[j] = carry % BASE;
                            carry = (carry / BASE) | 0;
                        }
                        while (carry > 0) {
                            digits.push(carry % BASE);
                            carry = (carry / BASE) | 0;
                        }
                    }

                    let string = '';
                    for (let i = 0; buffer[i] === 0 && i < buffer.length - 1; i++) {
                        string += ALPHABET[0];
                    }
                    for (let i = digits.length - 1; i >= 0; i--) {
                        string += ALPHABET[digits[i]];
                    }

                    return string;
                }
            };
        })();
    </script>
</body>
</html>
